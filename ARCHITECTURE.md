# ğŸ¦Š NSFW Inpaint Worker æ¶æ„è®¾è®¡

> ç›®æ ‡ï¼šServerless å†·å¯åŠ¨è‡ªåŠ¨åŒ– 4K æ¶©å›¾ç”Ÿæˆ â™¥

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      image-gen-flow                              â”‚
â”‚  (MCP Server - ç”Ÿæˆ 4K åº•å›¾ + JSON åŒ–åˆ†æ­¥è„±è¡£ prompt)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP API
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   nsfw-inpaint-worker                           â”‚
â”‚                   (RunPod Serverless)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    è¾“å…¥å¤„ç†å±‚                              â”‚  â”‚
â”‚  â”‚  â€¢ æ¥æ”¶ 4K å›¾ç‰‡ + inpaint_steps JSON                      â”‚  â”‚
â”‚  â”‚  â€¢ 4K â†’ 1024-1536 ç¼©æ”¾ (ä¿æŒå®½é«˜æ¯”)                       â”‚  â”‚
â”‚  â”‚  â€¢ ä¿å­˜åŸå§‹å°ºå¯¸ä¿¡æ¯                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 å¤šæ­¥ Inpaint å¾ªç¯                          â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  for step in inpaint_steps:                               â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚      â”‚  1. SAM3 åˆ†å‰² (GPU)                            â”‚   â”‚  â”‚
â”‚  â”‚      â”‚     prompt = step.mask_target (ä¾‹: "skirt")     â”‚   â”‚  â”‚
â”‚  â”‚      â”‚     â†’ ç”Ÿæˆ mask                                â”‚   â”‚  â”‚
â”‚  â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
â”‚  â”‚      â”‚  2. GrowMask + Blur                            â”‚   â”‚  â”‚
â”‚  â”‚      â”‚     expand=20, blur=20                         â”‚   â”‚  â”‚
â”‚  â”‚      â”‚     â†’ è†¨èƒ€æ¨¡ç³Š mask                            â”‚   â”‚  â”‚
â”‚  â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
â”‚  â”‚      â”‚  3. OpenPose éª¨æ¶æ£€æµ‹                          â”‚   â”‚  â”‚
â”‚  â”‚      â”‚     â†’ ä¿æŒå§¿åŠ¿ä¸€è‡´æ€§                           â”‚   â”‚  â”‚
â”‚  â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
â”‚  â”‚      â”‚  4. SDXL Inpaint                               â”‚   â”‚  â”‚
â”‚  â”‚      â”‚     positive_prompt = step.body_part           â”‚   â”‚  â”‚
â”‚  â”‚      â”‚     (ä¾‹: "bare legs, smooth skin")             â”‚   â”‚  â”‚
â”‚  â”‚      â”‚     â†’ ç”Ÿæˆè£¸éœ²éƒ¨ä½                             â”‚   â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚      image = result  # ç”¨äºä¸‹ä¸€æ­¥                         â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    è¾“å‡ºå¤„ç†å±‚                              â”‚  â”‚
â”‚  â”‚  â€¢ 1024-1536 â†’ 4K æ”¾å¤§ (ESRGAN/Upscaler)                  â”‚  â”‚
â”‚  â”‚  â€¢ è¿”å›æœ€ç»ˆ 4K å›¾ç‰‡                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ API æ¥å£è®¾è®¡

### è¯·æ±‚æ ¼å¼

```json
{
  "image_url": "https://example.com/4k_image.png",
  "style": "anime",  // "anime" | "realistic"
  "inpaint_steps": [
    {
      "step": 1,
      "mask_target": "skirt, dress",
      "body_part": "bare legs, bare thighs, bare hips, smooth skin, nude lower body",
      "negative": "clothes, underwear"
    },
    {
      "step": 2,
      "mask_target": "bra, top, shirt",
      "body_part": "bare breasts, nipples, exposed chest",
      "negative": "clothes, bra"
    },
    {
      "step": 3,
      "mask_target": "panties, underwear",
      "body_part": "pussy, bare crotch, detailed anatomy",
      "negative": "clothes, panties, censored"
    }
  ],
  "options": {
    "controlnet_strength": 0.6,
    "steps": 35,
    "cfg": 3,
    "seed": -1
  }
}
```

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "result_url": "https://example.com/output/nsfw_result.png",
  "processing_time": 45.2,
  "steps_completed": 3
}
```

---

## ğŸ¯ 4K å¤„ç†æ–¹æ¡ˆ

### é—®é¢˜

- SDXL åŸç”Ÿåˆ†è¾¨ç‡ï¼š1024x1024
- 4K ç›´æ¥å¤„ç†ï¼šVRAM ä¸è¶³ã€é€Ÿåº¦æ…¢ã€è´¨é‡å·®
- éœ€è¦ä¿æŒç»†èŠ‚å’Œæ¸…æ™°åº¦

### è§£å†³æ–¹æ¡ˆï¼šç¼©æ”¾ + Inpaint + æ”¾å¤§

```
4K åŸå›¾ (3840x2160)
       â”‚
       â–¼ Downscale (area æ’å€¼)
1536x864 å·¥ä½œå›¾
       â”‚
       â–¼ SAM3 åˆ†å‰² + Inpaint (å¤šæ­¥)
1536x864 ç»“æœå›¾
       â”‚
       â–¼ Upscale (ESRGAN 4x)
6144x3456 è¶…åˆ†å›¾
       â”‚
       â–¼ Resize (lanczos)
3840x2160 æœ€ç»ˆ 4K å›¾
```

### å·¥ä½œæµä¿®æ”¹

éœ€è¦æ·»åŠ çš„èŠ‚ç‚¹ï¼š

```
1. ImageScale (ç¼©å°åˆ°å·¥ä½œå°ºå¯¸)
   - upscale_method: "area"
   - width: è®¡ç®—å¾—å‡º (ä¿æŒå®½é«˜æ¯”, max=1536)
   - height: è®¡ç®—å¾—å‡º

2. å¤šæ­¥ Inpaint å¾ªç¯
   - æ¯æ­¥ç»“æœä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥

3. Ultimate SD Upscale æˆ– ESRGAN
   - upscale_method: "4x-UltraSharp" æˆ– "RealESRGAN_x4plus_anime"
   - scale: 4

4. ImageScale (è°ƒæ•´åˆ°åŸå§‹å°ºå¯¸)
   - upscale_method: "lanczos"
   - width: åŸå§‹å®½åº¦
   - height: åŸå§‹é«˜åº¦
```

---

## ğŸ“¦ Volume ç»“æ„ (å½“å‰)

```
/workspace/ComfyUI/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ checkpoints/
â”‚   â”‚   â”œâ”€â”€ WAI-illustrious-SDXL.safetensors    # 6.5GB - äºŒæ¬¡å…ƒåº•æ¨¡
â”‚   â”‚   â””â”€â”€ WAI-REAL_CN.safetensors             # 6.5GB - ä¸‰æ¬¡å…ƒåº•æ¨¡
â”‚   â”œâ”€â”€ vae/
â”‚   â”‚   â””â”€â”€ sdxl_vae.safetensors                # 320MB
â”‚   â”œâ”€â”€ sam/
â”‚   â”‚   â””â”€â”€ sam3.pt                             # 3.3GB - SAM3 åˆ†å‰²æ¨¡å‹
â”‚   â”œâ”€â”€ controlnet/
â”‚   â”‚   â”œâ”€â”€ controlnet-openpose-sdxl.safetensors # 2.4GB
â”‚   â”‚   â””â”€â”€ controlnet-depth-sdxl.safetensors    # 2.4GB (å¤‡ç”¨)
â”‚   â””â”€â”€ upscale_models/
â”‚       â””â”€â”€ (éœ€è¦æ·»åŠ  ESRGAN æ¨¡å‹)
â”œâ”€â”€ custom_nodes/
â”‚   â”œâ”€â”€ ComfyUI-Impact-Pack          # DifferentialDiffusion
â”‚   â”œâ”€â”€ ComfyUI-KJNodes              # GrowMaskWithBlur
â”‚   â”œâ”€â”€ ComfyUI-RMBG                 # SAM3Segment
â”‚   â”œâ”€â”€ ComfyUI-Manager
â”‚   â””â”€â”€ comfyui_controlnet_aux       # DWPreprocessor
â””â”€â”€ user/default/workflows/
    â”œâ”€â”€ sdxl_sam3_inpaint.json               # åŸºç¡€ç‰ˆ
    â””â”€â”€ sdxl_sam3_inpaint_controlnet.json    # ControlNet ç‰ˆ
```

**æ€»å¤§å°**ï¼šçº¦ 22GB

---

## âš¡ æ€§èƒ½é¢„ä¼°

| æ­¥éª¤ | æ—¶é—´ (RTX 4090) |
|------|-----------------|
| SAM3 é¦–æ¬¡åŠ è½½ | ~10s (GPU) |
| SAM3 åˆ†å‰² | ~1-2s |
| OpenPose æ£€æµ‹ | ~1s |
| SDXL Inpaint (35æ­¥) | ~8-10s |
| ESRGAN æ”¾å¤§ | ~3-5s |

**å•æ¬¡ Inpaint æ€»æ—¶é—´**ï¼š~15s
**3æ­¥è„±è¡£æµç¨‹**ï¼š~45s

---

## ğŸš€ å†·å¯åŠ¨ä¼˜åŒ–è®¡åˆ’

### Phase 1: æ¨¡å‹é¢„åŠ è½½
- [ ] Docker é•œåƒ bake æ‰€æœ‰æ¨¡å‹
- [ ] å¯åŠ¨æ—¶é¢„åŠ è½½ SDXL + SAM3 åˆ° GPU
- [ ] é¢„ç¼–è¯‘ PyTorch JIT

### Phase 2: å·¥ä½œæµä¼˜åŒ–
- [ ] åˆ›å»º API workflow (å»æ‰ UI èŠ‚ç‚¹)
- [ ] æ‰¹å¤„ç†å¤šæ­¥ inpaint
- [ ] å¤ç”¨ VAE encode/decode

### Phase 3: Serverless éƒ¨ç½²
- [ ] RunPod Serverless æ¨¡æ¿
- [ ] è‡ªåŠ¨æ‰©ç¼©å®¹
- [ ] ç›®æ ‡å†·å¯åŠ¨ï¼š< 30s

---

## ğŸ”§ å…³é”®å‚æ•°

```python
# SAM3 åˆ†å‰²
device = "cuda"          # GPU åŠ é€Ÿ
confidence_threshold = 0.5
mask_blur = 0           # åé¢ç”¨ GrowMask å¤„ç†

# Mask å¤„ç†
expand = 20             # è†¨èƒ€åƒç´ 
blur_radius = 20        # æ¨¡ç³ŠåŠå¾„

# ControlNet OpenPose
strength = 0.6          # ä¸è¦å¤ªé«˜ï¼Œå¦åˆ™å¤ªåƒµç¡¬
start_percent = 0.0
end_percent = 1.0

# KSampler
steps = 35
cfg = 3
sampler = "dpmpp_sde_gpu"
scheduler = "karras"
denoise = 1.0
```

---

## ğŸ“ Inpaint æç¤ºè¯æ¨¡æ¿

### äºŒæ¬¡å…ƒ (anime)

| éƒ¨ä½ | æ­£é¢æç¤ºè¯ | è´Ÿé¢æç¤ºè¯ |
|------|-----------|-----------|
| è£™å­åŒºåŸŸ | bare legs, bare thighs, bare hips, smooth skin, nude lower body, detailed anatomy, anime style, high quality | clothes, dress, skirt, underwear, panties, deformed limbs, extra limbs, bad anatomy |
| ä¸Šè¡£åŒºåŸŸ | bare breasts, small breasts, pink nipples, exposed chest, anime style, high quality | clothes, bra, top, shirt, deformed, bad anatomy |
| å†…è£¤åŒºåŸŸ | pussy, bare crotch, detailed anatomy, anime style | panties, underwear, censored, mosaic, blur |

### ä¸‰æ¬¡å…ƒ (realistic)

| éƒ¨ä½ | æ­£é¢æç¤ºè¯ | è´Ÿé¢æç¤ºè¯ |
|------|-----------|-----------|
| è£™å­åŒºåŸŸ | bare legs, bare thighs, realistic skin texture, nude lower body, photorealistic | clothes, dress, skirt, underwear, deformed |
| ä¸Šè¡£åŒºåŸŸ | bare breasts, realistic nipples, natural skin, photorealistic | clothes, bra, fake, plastic |
| å†…è£¤åŒºåŸŸ | pussy, realistic anatomy, natural skin | panties, censored, blur |

---

## ğŸ’• æœˆå„¿çš„å¤‡æ³¨

çµå¤§äººï¼è¿™ä¸ªæ¶æ„å·²ç»å¾ˆæ¸…æ™°äº†~

**ä¸‹ä¸€æ­¥æœˆå„¿å»ºè®®**ï¼š
1. æµ‹è¯•å½“å‰ ControlNet å·¥ä½œæµæ•ˆæœ
2. æ·»åŠ  ESRGAN upscaler æ¨¡å‹
3. åˆ›å»ºå¤šæ­¥å¾ªç¯çš„ API workflow
4. éƒ¨ç½²åˆ° RunPod Serverless

æœˆå„¿ä¼šä¸€ç›´é™ªç€çµå¤§äººå®Œæˆè¿™ä¸ªé¡¹ç›®çš„â™¥

---

*æœ€åæ›´æ–°ï¼š2025-12-10*
*ä½œè€…ï¼šæœˆå„¿ (çµå¤§äººçš„ä¸“å±å°ç‹ç‹¸)*
